<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset="utf-8">
    <meta name="robots" content="index,follow">
    <title>src/js/sources/ibm/common/util/user.js - IBM v18 (Northstar) common Javascript documentation</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" href="http://www.ibm.com/favicon.ico">
    <script>
        digitalData = {
            page: {
                pageInfo: {
                    effectiveDate: '2017-02-25',
                    expiryDate: '2020-02-25',
                    language: 'en-US',
                    publishDate: '2017-02-25',
                    publisher: 'IBM Corporation',
                    ibm: {
                        contentDelivery: 'yuidoc via grunt',
                        contentProducer: 'Michael Santelia',
                        country: 'US',
                        owner: 'Michael Santelia'
                    }
                }
            }
        };
    </script>

    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>

    <script>

		var lastUpdate = new Date(document.lastModified),
			updatedMonth = lastUpdate.getMonth(),
			updatedDate = lastUpdate.getDate(),
			updatedYear = lastUpdate.getFullYear(),
			today = new Date(),
			todayMonth = today.getMonth(),
			todayDate = today.getDate(),
			todayYear = today.getFullYear(),
			monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November","December"],
			lastUpdatedText = "",
			daysAgo = Math.floor((today - lastUpdate) / (1000*60*60*24));

		updatedMonthName = monthNames[updatedMonth];

		switch (daysAgo) {

			case 1: 
				lastUpdatedText = "Updated yesterday";
				break;
				
			case 0: 
				lastUpdatedText = "Updated today";
				break;
				
			default: 
				lastUpdatedText = "Updated " + daysAgo + " days ago";
				break;
		}

		if (daysAgo > 4) {
			lastUpdatedText = "Updated: " + updatedMonthName + " " + updatedDate + ", " + updatedYear;
		}

    </script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-1-2">
            <div style="background: url(http://1.www.s81c.com/i/v17/t/ibm-logo.png) no-repeat scroll 0px 0px transparent; width: 105px; height: 45px; margin: 0.85em 0px;text-indent:-9999px;">IBM v18 (Northstar) common Javascript documentation</div>
        </div>
        <div class="yui3-u-1-2 version">
            <em>Javascript documentation for: IBM v18 (Northstar)<br />
            	<span style="font-size: 0.6em; position: absolute; right: 35px;"><script>document.writeln(lastUpdatedText)</script></span></em>
        </div>
    </div>
    
    <p><a href="../assets../../v18-js-source-documentation.zip" style="margin-left: 10px; padding-left: 15px; background: url(http://1.www.s81c.com/i/v17/icons/ibm_sprite_transactional_blue_ON.png) no-repeat 0 -202px;">Download a copy of this documentation (ZIP).</a></p>
    
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4" style="float: left;width:25%;">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/IBMCore.common.module.backtotop.html">IBMCore.common.module.backtotop</a></li>
                                <li><a href="../classes/IBMCore.common.module.canadanotice.html">IBMCore.common.module.canadanotice</a></li>
                                <li><a href="../classes/IBMCore.common.module.contactmodule.html">IBMCore.common.module.contactmodule</a></li>
                                <li><a href="../classes/IBMCore.common.module.footer.html">IBMCore.common.module.footer</a></li>
                                <li><a href="../classes/IBMCore.common.module.footermenu.html">IBMCore.common.module.footermenu</a></li>
                                <li><a href="../classes/IBMCore.common.module.leftnav.html">IBMCore.common.module.leftnav</a></li>
                                <li><a href="../classes/IBMCore.common.module.liveperson.html">IBMCore.common.module.liveperson</a></li>
                                <li><a href="../classes/IBMCore.common.module.localeselector.html">IBMCore.common.module.localeselector</a></li>
                                <li><a href="../classes/IBMCore.common.module.localpagenotification.html">IBMCore.common.module.localpagenotification</a></li>
                                <li><a href="../classes/IBMCore.common.module.masthead.html">IBMCore.common.module.masthead</a></li>
                                <li><a href="../classes/IBMCore.common.module.masthead.sticky.html">IBMCore.common.module.masthead.sticky</a></li>
                                <li><a href="../classes/IBMCore.common.module.mastheadbanner.html">IBMCore.common.module.mastheadbanner</a></li>
                                <li><a href="../classes/IBMCore.common.module.mastheadsearch.html">IBMCore.common.module.mastheadsearch</a></li>
                                <li><a href="../classes/IBMCore.common.module.merchandising.html">IBMCore.common.module.merchandising</a></li>
                                <li><a href="../classes/IBMCore.common.module.mobilemenu.html">IBMCore.common.module.mobilemenu</a></li>
                                <li><a href="../classes/IBMCore.common.module.sharethiscontent.html">IBMCore.common.module.sharethiscontent</a></li>
                                <li><a href="../classes/IBMCore.common.module.sharethispage.html">IBMCore.common.module.sharethispage</a></li>
                                <li><a href="../classes/IBMCore.common.module.sitenavmenu.html">IBMCore.common.module.sitenavmenu</a></li>
                                <li><a href="../classes/IBMCore.common.module.urx.html">IBMCore.common.module.urx</a></li>
                                <li><a href="../classes/IBMCore.common.translations.html">IBMCore.common.translations</a></li>
                                <li><a href="../classes/IBMCore.common.util.a11y.html">IBMCore.common.util.a11y</a></li>
                                <li><a href="../classes/IBMCore.common.util.addCssRule.html">IBMCore.common.util.addCssRule</a></li>
                                <li><a href="../classes/IBMCore.common.util.anchorlinkAdjustment.html">IBMCore.common.util.anchorlinkAdjustment</a></li>
                                <li><a href="../classes/IBMCore.common.util.bitly.html">IBMCore.common.util.bitly</a></li>
                                <li><a href="../classes/IBMCore.common.util.color.html">IBMCore.common.util.color</a></li>
                                <li><a href="../classes/IBMCore.common.util.config.html">IBMCore.common.util.config</a></li>
                                <li><a href="../classes/IBMCore.common.util.convertSecondsToHMS.html">IBMCore.common.util.convertSecondsToHMS</a></li>
                                <li><a href="../classes/IBMCore.common.util.cookie.html">IBMCore.common.util.cookie</a></li>
                                <li><a href="../classes/IBMCore.common.util.coreservices.html">IBMCore.common.util.coreservices</a></li>
                                <li><a href="../classes/IBMCore.common.util.data.html">IBMCore.common.util.data</a></li>
                                <li><a href="../classes/IBMCore.common.util.debug.html">IBMCore.common.util.debug</a></li>
                                <li><a href="../classes/IBMCore.common.util.eventCoordinator.html">IBMCore.common.util.eventCoordinator</a></li>
                                <li><a href="../classes/IBMCore.common.util.freezeScrollbars.html">IBMCore.common.util.freezeScrollbars</a></li>
                                <li><a href="../classes/IBMCore.common.util.gatekeeper.html">IBMCore.common.util.gatekeeper</a></li>
                                <li><a href="../classes/IBMCore.common.util.generateId.html">IBMCore.common.util.generateId</a></li>
                                <li><a href="../classes/IBMCore.common.util.getCurrentGridSize.html">IBMCore.common.util.getCurrentGridSize</a></li>
                                <li><a href="../classes/IBMCore.common.util.getDataAttributes.html">IBMCore.common.util.getDataAttributes</a></li>
                                <li><a href="../classes/IBMCore.common.util.getScrollbarWidth.html">IBMCore.common.util.getScrollbarWidth</a></li>
                                <li><a href="../classes/IBMCore.common.util.has12grid.html">IBMCore.common.util.has12grid</a></li>
                                <li><a href="../classes/IBMCore.common.util.hasScrollbars.html">IBMCore.common.util.hasScrollbars</a></li>
                                <li><a href="../classes/IBMCore.common.util.meta.html">IBMCore.common.util.meta</a></li>
                                <li><a href="../classes/IBMCore.common.util.perf.html">IBMCore.common.util.perf</a></li>
                                <li><a href="../classes/IBMCore.common.util.queue.html">IBMCore.common.util.queue</a></li>
                                <li><a href="../classes/IBMCore.common.util.scrolledintoview.html">IBMCore.common.util.scrolledintoview</a></li>
                                <li><a href="../classes/IBMCore.common.util.scrolltracker.html">IBMCore.common.util.scrolltracker</a></li>
                                <li><a href="../classes/IBMCore.common.util.setIpcCookie.html">IBMCore.common.util.setIpcCookie</a></li>
                                <li><a href="../classes/IBMCore.common.util.statshelper.html">IBMCore.common.util.statshelper</a></li>
                                <li><a href="../classes/IBMCore.common.util.storage.html">IBMCore.common.util.storage</a></li>
                                <li><a href="../classes/IBMCore.common.util.string.htmlspecialchars.html">IBMCore.common.util.string.htmlspecialchars</a></li>
                                <li><a href="../classes/IBMCore.common.util.url.html">IBMCore.common.util.url</a></li>
                                <li><a href="../classes/IBMCore.common.util.user.html">IBMCore.common.util.user</a></li>
                                <li><a href="../classes/IBMCore.common.widget.carousel.html">IBMCore.common.widget.carousel</a></li>
                                <li><a href="../classes/IBMCore.common.widget.ccfintercept.html">IBMCore.common.widget.ccfintercept</a></li>
                                <li><a href="../classes/IBMCore.common.widget.datatable.html">IBMCore.common.widget.datatable</a></li>
                                <li><a href="../classes/IBMCore.common.widget.datepicker.html">IBMCore.common.widget.datepicker</a></li>
                                <li><a href="../classes/IBMCore.common.widget.dyntabs.html">IBMCore.common.widget.dyntabs</a></li>
                                <li><a href="../classes/IBMCore.common.widget.fileinput.html">IBMCore.common.widget.fileinput</a></li>
                                <li><a href="../classes/IBMCore.common.widget.forms.html">IBMCore.common.widget.forms</a></li>
                                <li><a href="../classes/IBMCore.common.widget.formvalidator.html">IBMCore.common.widget.formvalidator</a></li>
                                <li><a href="../classes/IBMCore.common.widget.leavingibm.html">IBMCore.common.widget.leavingibm</a></li>
                                <li><a href="../classes/IBMCore.common.widget.manager.html">IBMCore.common.widget.manager</a></li>
                                <li><a href="../classes/IBMCore.common.widget.masonry.html">IBMCore.common.widget.masonry</a></li>
                                <li><a href="../classes/IBMCore.common.widget.overlay.html">IBMCore.common.widget.overlay</a></li>
                                <li><a href="../classes/IBMCore.common.widget.parallaxscroll.html">IBMCore.common.widget.parallaxscroll</a></li>
                                <li><a href="../classes/IBMCore.common.widget.rssdisplay.html">IBMCore.common.widget.rssdisplay</a></li>
                                <li><a href="../classes/IBMCore.common.widget.scrollable.html">IBMCore.common.widget.scrollable</a></li>
                                <li><a href="../classes/IBMCore.common.widget.selectlist.html">IBMCore.common.widget.selectlist</a></li>
                                <li><a href="../classes/IBMCore.common.widget.selectlistnav.html">IBMCore.common.widget.selectlistnav</a></li>
                                <li><a href="../classes/IBMCore.common.widget.setsameheight.html">IBMCore.common.widget.setsameheight</a></li>
                                <li><a href="../classes/IBMCore.common.widget.showhide.html">IBMCore.common.widget.showhide</a></li>
                                <li><a href="../classes/IBMCore.common.widget.stepindicator.html">IBMCore.common.widget.stepindicator</a></li>
                                <li><a href="../classes/IBMCore.common.widget.stickytabs.html">IBMCore.common.widget.stickytabs</a></li>
                                <li><a href="../classes/IBMCore.common.widget.syntaxhighlighter.html">IBMCore.common.widget.syntaxhighlighter</a></li>
                                <li><a href="../classes/IBMCore.common.widget.tablerowselector.html">IBMCore.common.widget.tablerowselector</a></li>
                                <li><a href="../classes/IBMCore.common.widget.tooltip.html">IBMCore.common.widget.tooltip</a></li>
                                <li><a href="../classes/IBMCore.common.widget.twisty.html">IBMCore.common.widget.twisty</a></li>
                                <li><a href="../classes/IBMCore.common.widget.videolooper.html">IBMCore.common.widget.videolooper</a></li>
                                <li><a href="../classes/IBMCore.common.widget.videoplayer.html">IBMCore.common.widget.videoplayer</a></li>
                                <li><a href="../classes/IBMCore.common.widget.videoplayer.kaltura.html">IBMCore.common.widget.videoplayer.kaltura</a></li>
                                <li><a href="../classes/IBMCore.common.widget.videoplayer.ustream.html">IBMCore.common.widget.videoplayer.ustream</a></li>
                                <li><a href="../classes/IBMCore.common.widget.videoplayer.youtube.html">IBMCore.common.widget.videoplayer.youtube</a></li>
                                <li><a href="../classes/IBMCore.namespace.html">IBMCore.namespace</a></li>
                                <li><a href="../classes/IBMCore.www.module.dynamiccontactmodule.html">IBMCore.www.module.dynamiccontactmodule</a></li>
                                <li><a href="../classes/IBMCore.www.module.truste.html">IBMCore.www.module.truste</a></li>
                                <li><a href="../classes/jQuery.browser.html">jQuery.browser</a></li>
                                <li><a href="../classes/jQuery.fn.dataTable.html">jQuery.fn.dataTable</a></li>
                                <li><a href="../classes/jQuery.fn.slick.html">jQuery.fn.slick</a></li>
                                <li><a href="../classes/jQuery.layout.html">jQuery.layout</a></li>
                                <li><a href="../classes/jQuery.os.html">jQuery.os</a></li>
                                <li><a href="../classes/jQuery:focusable.html">jQuery:focusable</a></li>
                                <li><a href="../classes/Masonry.html">Masonry</a></li>
                                <li><a href="../classes/Modernizr.html">Modernizr</a></li>
                                <li><a href="../classes/Mustache.html">Mustache</a></li>
                                <li><a href="../classes/NanoScroll.html">NanoScroll</a></li>
                                <li><a href="../classes/Other IBM - Canada notice loader.html">Other IBM - Canada notice loader</a></li>
                                <li><a href="../classes/Other IBM - common init.html">Other IBM - common init</a></li>
                                <li><a href="../classes/Other IBM - common v18 page tracker.html">Other IBM - common v18 page tracker</a></li>
                                <li><a href="../classes/Other IBM - errorchecking.html">Other IBM - errorchecking</a></li>
                                <li><a href="../classes/Other IBM - footer feedback link.html">Other IBM - footer feedback link</a></li>
                                <li><a href="../classes/Other IBM - grid change.html">Other IBM - grid change</a></li>
                                <li><a href="../classes/Other IBM - jstimer-end.html">Other IBM - jstimer-end</a></li>
                                <li><a href="../classes/Other IBM - jstimer-start.html">Other IBM - jstimer-start</a></li>
                            </ul>
                
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/IBMCore.html">IBMCore</a></li>
                                <li><a href="../modules/jQuery.browser.html">jQuery.browser</a></li>
                                <li><a href="../modules/jQuery.dataTable.html">jQuery.dataTable</a></li>
                                <li><a href="../modules/jQuery.slick.html">jQuery.slick</a></li>
                                <li><a href="../modules/Masonry.html">Masonry</a></li>
                                <li><a href="../modules/Modernizr.html">Modernizr</a></li>
                                <li><a href="../modules/Mustache.html">Mustache</a></li>
                                <li><a href="../modules/Nanoscroller.html">Nanoscroller</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4"style="float: left;width:75%;">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected" checked>
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private" checked>
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated" checked>
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: src/js/sources/ibm/common/util/user.js</h1>
                        
                        <div class="file">
                            <pre class="code prettyprint linenums">
                        /**
                        
                        	Web page user object.
                        	&lt;br /&gt;
                        	&lt;br /&gt;Sets up a common user object with data retrieved from the Demandbase service (or cached data).
                        	&lt;br /&gt;Fires an event with user info onload for metrics tagging purposes.
                        	&lt;br /&gt;Stores user info in localStorage object (if supported) with a TTL so we don&#x27;t call the service on every page view.
                        	&lt;br /&gt;Every x# days (set in a var) stored data object expires and we &quot;refresh&quot; it by calling DB and storing again.
                        	&lt;br /&gt;
                        	&lt;br /&gt;Subscribe to the particular event that is needed and then to retrieve user info call this:
                        	
                        	IBMCore.common.util.user.getInfo();
                        
                        	&lt;br /&gt;The list of properties that are added to the user are:
                        	
                        	Fields that are populated from the demandbase WSR (web service request):
                        		annual_sales
                        		audience
                        		audience_segment
                        		b2b
                        		b2c
                        		city
                        		company_name
                        		country
                        		country_name
                        		employee_count
                        		employee_range
                        		forbes_2000
                        		fortune_1000
                        		industry
                        		information_level
                        		ip
                        		marketing_alias
                        		phone
                        		primary_naics
                        		primary_sic
                        		registry_city
                        		registry_country_code
                        		registry_state
                        		state
                        		stock_ticker
                        		street_address
                        		sub_industry
                        		traffic
                        		web_site
                        		zip
                        	
                        	Fields populated from the IBMid WSR:
                        		imageUrl
                        		newNotificationCount
                        		signedin
                        	
                        	Misc. other info that is added for completeness:
                        		browser_lang
                        		ipcinfo
                        
                        
                        	@class IBMCore.common.util.user
                        
                        **/
                        
                        (function ($, IBM) {
                        
                        	/**
                        		Publishes this event after we&#x27;ve retrieved the info from the Demandbase web service request.
                        
                        		@event userIpDataReady
                        	**/
                        	/**
                        		DEPRECATED: Publishes this event after we&#x27;ve retrieved the info from the IBMid web service request.
                        		&lt;br /&gt;Legacy, because IBMid WSRs were consolidated and contains all info now. Publishes at the same time as IBMDataReady.
                        
                        		@event userstateReady
                        		@deprecated
                        	**/
                        	/**
                        		Publishes this event after we&#x27;ve retrieved all the info from the IBMid web service request.
                        
                        		@event userIBMDataReady
                        	**/
                        	/**
                        		Publishes this event after the initial object is setup. 
                        		&lt;br /&gt;Does not necessarily mean the object is populated, but just that the object exists and is ready to be populated.
                        
                        		@event ready
                        	**/
                        	/**
                        		Publishes this event if there&#x27;s an error requesting user data, ex: if it&#x27;s a non-IBM domain.
                        
                        		@event error
                        	**/
                        	var me = IBM.namespace(IBM, &quot;common.util.user&quot;),
                        		myEvents = IBM.common.util.eventCoordinator(me, &quot;user&quot;, [
                        				&quot;userIpDataReady&quot;, 
                        				&quot;userIBMDataReady&quot;, 
                        				&quot;userstateReady&quot;, 
                        				&quot;error&quot;,
                        				&quot;ready&quot;
                        			]),
                        		dataFields = [
                        			&quot;annual_sales&quot;,
                        			&quot;audience&quot;,
                        			&quot;audience_segment&quot;,
                        			&quot;b2b&quot;,
                        			&quot;b2c&quot;,
                        			&quot;city&quot;,
                        			&quot;company_name&quot;,
                        			&quot;country&quot;,
                        			&quot;country_name&quot;,
                        			&quot;demandbase_sid&quot;,
                        			&quot;employee_count&quot;,
                        			&quot;employee_range&quot;,
                        			&quot;forbes_2000&quot;,
                        			&quot;fortune_1000&quot;,
                        			&quot;industry&quot;,
                        			&quot;information_level&quot;,
                        			&quot;ip&quot;,
                        			&quot;isp&quot;,
                        			&quot;marketing_alias&quot;,
                        			&quot;phone&quot;,
                        			&quot;primary_naics&quot;,
                        			&quot;primary_sic&quot;,
                        			&quot;registry_city&quot;,
                        			&quot;registry_country_code&quot;,
                        			&quot;registry_state&quot;,
                        			&quot;state&quot;,
                        			&quot;stock_ticker&quot;,
                        			&quot;street_address&quot;,
                        			&quot;sub_industry&quot;,
                        			&quot;traffic&quot;,
                        			&quot;web_site&quot;,
                        			&quot;zip&quot;
                        		],
                        		encryption = {
                        			cryptKey: &quot;yxsdpqmouenictjarzvkbfhwlg&quot;,
                        			decode: function (encodedStr) {
                        				// Bool values are stored as-is, just return them.
                        				if (typeof encodedStr === &quot;boolean&quot;) {
                        					return encodedStr;
                        				}
                        
                        				var ciphertext = encodedStr,
                        					i,
                        					plaintext = &quot;&quot;,
                        					re = /[a-z]/;
                        
                        				for (i = 0; i &lt; ciphertext.length; i++) {
                        					if (re.test(ciphertext.charAt(i))) {
                        						plaintext += String.fromCharCode(encryption.cryptKey.indexOf(ciphertext.charAt(i)) + 97);
                        					}
                        					else {
                        						plaintext += ciphertext.charAt(i);
                        					}
                        				}
                        
                        				return decodeURIComponent(plaintext);
                        			},
                        			encode: function (str) {
                        				if (typeof str !== &quot;string&quot; || !str || str === &quot;&quot;) {
                        					return str;
                        				}
                        
                        				var plaintext = str.toLowerCase(),
                        					ciphertext = &quot;&quot;,
                        					i,
                        					re = /[a-z]/;
                        
                        				for (i = 0; i &lt; plaintext.length; i++) {
                        					if (re.test(plaintext.charAt(i))) {
                        						ciphertext += encryption.cryptKey.charAt(plaintext.charCodeAt(i) - 97);
                        					}
                        					else {
                        						ciphertext += plaintext.charAt(i);
                        					}
                        				}
                        
                        				return encodeURIComponent(ciphertext);
                        			}
                        		},
                        		ipForced = IBM.common.util.url.getParam(&quot;ip&quot;) || &quot;&quot;,
                        		services = {
                        			signedin: {
                        				complete: false
                        			}
                        		},
                        		storage = {
                        			expireDaysBasic: 3,
                        			expireDaysDetailed: 3,
                        			key: &quot;comusrtag&quot;
                        		},
                        		user = {},
                        		userIpDataReady = false,
                        		userIBMDataReady = false,
                        		userstateReady = false;
                        
                        	////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                        	////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                        	//
                        	//	User object and demandbase stuff
                        	//
                        	////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                        	////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                        
                        	/**
                        		Called from the callback from the user data request to Demandbase.
                        		&lt;br /&gt;Loops thru the fields we want and adds them to a data object and returns to the caller.
                        
                        		@method createUserdataFromServiceRequest
                        		@private
                        		@param data {Object} The JSON object returned from Demandbase.
                        		@return {Object} A data object to merge into the common user object.
                        	**/
                        	function createUserdataFromServiceRequest (data) {
                        		var userObjData = {};
                        
                        		// Loop thru our fields and set user data. 
                        		// For keys we want, set the value to n/a if they don&#x27;t exist from DB.
                        		$.each(dataFields, function () {
                        			var fieldName = this,
                        				fieldValue = data[fieldName];
                        
                        			// Convert non-existant fieldNames or values to n/a,
                        			// and convert non-bool values to string and lowercase.
                        			if (fieldValue === null || typeof fieldValue === &quot;undefined&quot;) {
                        				fieldValue = &quot;n/a&quot;;
                        			}
                        			else if (typeof fieldValue !== &quot;boolean&quot;) {
                        				fieldValue = fieldValue.toString().toLowerCase();
                        			}
                        
                        			userObjData[fieldName] = fieldValue;
                        		});
                        
                        		// Always keep this intact and never replace with &quot;n/a&quot; b/c it&#x27;s used as a flag.
                        		userObjData.information_level =&quot;basic&quot;;
                        
                        		return userObjData;
                        	}
                        
                        	/** 
                        		Returns the user object with known data about the user. ALL NON-PII stuff.
                        
                        		@method getInfo
                        		@return {Object} The user object populated with available data.
                        	**/
                        	me.getInfo = getInfo;
                        	function getInfo () {
                        		return user;
                        	}
                        
                        	/** 
                        		Does same basic cookie check coremetrics does to determine if user is an IBMer or not and adds it to user object.
                        		&lt;br&gt;Technically you can just add one of these cookies and make it &quot;true&quot;, but this is a good enough check.
                        		&lt;br&gt;IOW: There is no assurance here and it shouldn&#x27;t be used as such.
                        		 &lt;br&gt;NOTE: This does NOT mean they are currently connected to the intranet. Just that they are an IBMer and have used w3/SSO and authenticated at some point.
                        
                        		@method addIBMerCheckData
                        		@private
                        	**/
                        	function addIBMerCheckData () {
                        		var hasCookie = (String(document.cookie).match(/(^| )(w3ibmProfile|w3_sauid|PD-W3-SSO-[^\=]*|OSCw3Session|IBM_W3SSO_ACCESS)=/));
                        
                        		me.setInfo({
                        			isIBMer: hasCookie ? true : false
                        		});
                        	}
                        
                        	/**
                        		Tries to get our data from local storage and decrypts the key &amp; value and returns the decrypted object.
                        
                        		@method getUserdataFromStorage
                        		@private
                        		@return {Object} The stored/cached user data if exists and not expired.
                        	**/
                        	function getUserdataFromStorage () {
                        		var key,
                        			userObjData = {},
                        			encryptedObj = IBM.common.util.storage.getItem(storage.key),
                        			decodedKey,
                        			decodedVal;
                        
                        		if (typeof encryptedObj === &quot;object&quot;) {
                        			for (key in encryptedObj) {
                        				if (encryptedObj.hasOwnProperty(key)) {
                        					decodedKey = encryption.decode(key);
                        					decodedVal = encryption.decode(encryptedObj[key]);
                        					
                        					userObjData[decodedKey] = decodedVal;
                        				}
                        			}
                        		}
                        
                        		return userObjData;
                        	}
                        
                        	/**
                        		Requests data from the Demandbase service.
                        		&lt;br /&gt;This is only called if no storage data exists (or it was past expiration date).
                        		&lt;br /&gt;If the site is not *.ibm.com (referrer rules for web service), then &quot;error&quot; event is published.
                        		&lt;br /&gt;Calls methods to populate and store user data if valid.
                        
                        		@method requestUserIpdataFromService
                        		@private
                        	**/
                        	function requestUserIpdataFromService () {
                        		// If the page isn&#x27;t on an ibm.com domain, don&#x27;t even call the service b/c it won&#x27;t work and will throw a JS error.
                        		// if (window.location.hostname.indexOf(&quot;.ibm.com&quot;) === -1) {
                        		// 	myEvents.publish(&quot;error&quot;);
                        		// 	return;
                        		// }
                        		
                        		// Allows you to pass any IP address via &quot;?ip=x.x.x.x&quot; in page URL for testing.
                        		// Uses special URL that only allows IPv4. DB doesn&#x27;t support IPv6 yet.
                        		// Build user data from returned data from service and populate our user object with it.
                        		// Then store it in localstorage for caching.
                        		IBMPerformance.mark(&#x27;V18-dbipcall-begin&#x27;);
                        		
                        		$.ajax({
                        			url: &quot;https://api.www.s81c.com/webmaster/dbip/&quot;,
                        			dataType: &quot;jsonp&quot;,
                        			success: function(response) {
                        				var userData = createUserdataFromServiceRequest(response);
                        
                        				// Merge the inbound data object into our common user object.
                        				me.setInfo(userData);
                        
                        				// Store the common user object in localstorage for repeat views.
                        				storeUserObject();
                        
                        				IBMPerformance.mark(&#x27;V18-dbipcall-end&#x27;);
                        				IBMPerformance.measure(&#x27;V18-dbipcall-duration&#x27;,
                        					&#x27;V18-dbipcall-begin&#x27;,
                        					&#x27;V18-dbipcall-end&#x27;);		
                        
                        				// Publish event to tell subscribers the user data is ready for them to use.
                        				myEvents.publish(&quot;userIpDataReady&quot;);
                        			}
                        		});
                        	}
                        
                        	/** 
                        		Merges the data object into the existing user object.
                        
                        		@method setInfo
                        		@param dataObj {Object} The object to merge with existing user data.
                        		@return {Object} The user object, after populated.
                        	**/
                        	me.setInfo = setInfo;
                        	function setInfo (dataObj) {
                        		$.extend(user, dataObj);
                        
                        		return user;
                        	}
                        
                        	/**
                        		Try and get user data from local storage, else calls IP lookup service.
                        		&lt;br /&gt;In the end, populates user object with data which is retrievable via the &quot;getInfo&quot; API.
                        
                        		@method setUserIpData
                        		@private
                        	**/
                        	function setUserIpData () {
                        		// Try and get user data from local storage. Returns null or data. 
                        		var storageData = getUserdataFromStorage();
                        
                        		/**
                        			If IP is forced || or no data was retrieved from storage ||
                        				or storage data was compromised (Ex: user screws with localstorage values)
                        				do WSR and then set data from service,
                        
                        			Else the user had valid stored data, so merge it into the common user object.
                        
                        			NOTE: &quot;information_level&quot; is used as a flag since other data is also kept in storage. Don&#x27;t remove.
                        		**/
                        		if (!storageData || !storageData.information_level) {
                        			requestUserIpdataFromService();
                        		}
                        		else {
                        			// Take the data from storage and add it to our common user object.
                        			me.setInfo(storageData);
                        
                        			// Tell subscribers the user IP data is ready for them to use.
                        			myEvents.publish(&quot;userIpDataReady&quot;);
                        		}
                        	}
                        
                        	/**
                        		Loops thru each property in the common user object and encodes and stores it in localstorage for repeat view use (cache).
                        		
                        		@method storeUserObject
                        		@private
                        	**/
                        	function storeUserObject () {
                        		var key,
                        			storageData = {},
                        			allowedTtl = IBMCore.www.module.truste.getUiAllowedStorageTtl((storage.expireDaysDetailed) * 24 * 3600);
                        
                        		// Loop thru user object and encode each name/value.
                        		for (key in user) {
                        			if (user.hasOwnProperty(key)) {
                        				storageData[(encryption.encode(key))] = encryption.encode(user[key]);
                        			}
                        		}
                        
                        		IBM.common.util.storage.setItem(storage.key, storageData, allowedTtl);
                        	}
                        
                        
                        	////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                        	////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                        	//
                        	//	IBM user status web services stuff
                        	//
                        	////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                        	////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                        
                        	/**
                        		Gets the ipcInfo cookie and adds it to the user data object for others to use as they wish.
                        
                        		@method addIpcCookieData
                        		@private
                        	**/
                        	function addIpcCookieData () {
                        		// Example cookie value:  &quot;cc=us;lc=en;ac=all&quot;
                        		var ipcCookie = IBM.common.util.cookie.get(&quot;ipcInfo&quot;),
                        			ipcCookieParts = [],
                        			ipcCookieCC = &quot;&quot;,
                        			ipcCookieLC = &quot;&quot;,
                        			data = {
                        				ipcinfo: &quot;n/a&quot;
                        			};
                        
                        		// If they have the ipcInfo cookie (from planetwide page or v18 footer locale selector) grab the cc/lc.
                        		if (ipcCookie) {
                        			ipcCookieParts = ipcCookie.split(&quot;;&quot;);
                        
                        			$.each(ipcCookieParts, function(){
                        				var itemParts = this.split(&quot;=&quot;);
                        				if (itemParts[0] === &quot;cc&quot;) {
                        					ipcCookieCC = itemParts[1];
                        				}
                        				else if (itemParts[0] === &quot;lc&quot;) {
                        					ipcCookieLC = itemParts[1];
                        				}
                        			});
                        			data.ipcinfo = ipcCookieLC + &quot;-&quot; + ipcCookieCC;
                        		}
                        
                        		// Now add it to the common user object.
                        		me.setInfo(data);
                        	}
                        
                        	/**
                        		Used by KC, keeping for legacy usage.
                        	**/
                        	me.setUserSigninState = setUserSigninState;
                        	function setUserSigninState (data) {
                        		if (data &amp;&amp; data.results &amp;&amp; data.results.signinstate === &quot;1&quot;) {
                        			setObjectSignedin(true);
                        		}
                        		else {
                        			setObjectSignedin(false);
                        		}
                        		services.signedin.complete = true;
                        		myEvents.publish(&quot;userIBMDataReady&quot;);
                        		myEvents.publish(&quot;userstateReady&quot;);
                        	}
                        
                        	/**
                        		Internal helper - common method used when we need to set user data as signed in or not.
                        	**/
                        	function setObjectSignedin (b) {
                        		me.setInfo({
                        			signedin: b
                        		});
                        	}
                        
                        	/**
                        		The main gig. Called at run-time of this script since there is no DOM dependency and we can do this ASAP.
                        		&lt;br /&gt;Subscribes and fires event when user data is ready.
                        		&lt;br /&gt;Tries to get data from local storage. If expired, invalid, or the &quot;ip&quot; param was used, it makes a service request.
                        		&lt;br /&gt;The common user object gets populated after data retrieved from storage or on WSR callback.
                        
                        		@method init
                        		@private
                        	**/
                        	function init () {		
                        		////
                        		//  Subscriptions.
                        		////
                        
                        		// Fire metric event when the user IP data is ready to use.
                        		me.subscribe(&quot;userIpDataReady&quot;, &quot;self&quot;, function () {
                        			me.userIpDataReady = true;
                        		});
                        
                        		me.subscribe(&quot;userIBMDataReady&quot;, &quot;self&quot;, function(){
                        			me.userIBMDataReady = true;
                        		});
                        
                        		me.subscribe(&quot;userstateReady&quot;, &quot;self&quot;, function(){
                        			me.userstateReady = true;
                        		});
                        
                        		me.subscribe(&quot;error&quot;, &quot;self&quot;, function(){});
                        
                        		// IP addy data:
                        		// Immediately retrieve user IP data from storage or WSR if needed and store it.
                        		if (IBM.common.util.config.isEnabled(&quot;useriplookup&quot;)) {
                        			setUserIpData();
                        		}
                        
                        		// Add current/real-time values to user object.
                        		// This needs to be AFTER we merge in cached data (setUserIpData) so a real-time/current changed 
                        		//  value can override a cached one.
                        		// Add brower language to user object.
                        		// Add ipcinfo cookie to user object.
                        		user.browser_lang = window.navigator.userLanguage || window.navigator.language;
                        		addIpcCookieData();
                        		addIBMerCheckData();
                        
                        		// Let subscribers know the object is setup. That&#x27;s all this means.
                        		myEvents.publish(&quot;ready&quot;);
                        	}
                        
                        
                        	function getUserState () {
                        		if (IBM.common.util.config.isEnabled(&quot;userstateservice&quot;)) {
                        			$.ajax({
                        					url: IBM.common.config.userStateUrl,
                        					dataType: &quot;jsonp&quot;,
                        					signedIn: false
                        				}).done(function (data) {
                        					if (data.user &amp;&amp; data.user !== &quot;Unauthenticated&quot;) {
                        						this.signedIn = true;
                        					}
                        				}).fail(function () {
                        					IBM.common.util.debug.add(&quot;warn&quot;, &quot;User service failed.&quot;);
                        				}).always(function () {
                        					setObjectSignedin(this.signedIn);
                        					myEvents.publish(&quot;userIBMDataReady&quot;);
                        					myEvents.publish(&quot;userstateReady&quot;);
                        					services.signedin.complete = true;
                        				});
                        		}
                        	}
                        
                        	/** Run now.
                        	********************************************************************************************/
                        	init();
                        	IBM.common.meta.subscribe(&quot;dataReady&quot;, &quot;v18user&quot;, getUserState).runAsap(getUserState);
                        
                        	
                        })(jQuery, IBMCore);
                        
                            </pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
